name: Trading Reports & Execution

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '30 2 * * *'
    - cron: '30 4 * * *'
    - cron: '30 14 * * *'
    - cron: '30 15 * * *'
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'morning | trade | cleanup | night'
        required: false
        default: 'morning'
      run_tag:
        description: 'Optional report tag (example: r1)'
        required: false
        default: ''

permissions:
  contents: write
  actions: write

jobs:
  morning-generate:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'morning') ||
      (github.event_name == 'schedule' && github.event.schedule == '30 2 * * *')
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install TA-Lib
        run: |
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
          cd ..
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt
      - name: Generate reports
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python backend/generate_reports.py --mode generate
      - name: Configure Git user
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      - name: Commit and push reports
        run: |
          # Use a more robust way to detect changes including deletions
          git add reports/
          if ! git diff --cached --quiet; then
            git commit -m "Add morning reports for $(date +'%Y-%m-%d')"
            git push
          else
            echo "No changes in reports directory"
          fi
      - name: Clean up temporary files
        run: |
          rm -f backend/charts/* 2>/dev/null || true

  sensex-trade:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'trade') ||
      (github.event_name == 'schedule' && github.event.schedule == '30 4 * * *')
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install TA-Lib
        run: |
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
          cd ..
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt
      - name: Execute Sensex F&O trades
        env:
          CAPITAL: ${{ vars.CAPITAL }}
          PREMIUM_MIN: 50
          PREMIUM_MAX: 65
          ALLOCATION_PCT: ${{ vars.ALLOCATION_PCT }}
          MAX_SPREAD_PCT: ${{ vars.MAX_SPREAD_PCT }}
          OI_CHANGE_PCT: 0.10
          SENSEX_LOT_SIZE: ${{ vars.SENSEX_LOT_SIZE }}
          IS_EXPIRY_DAY: ${{ vars.IS_EXPIRY_DAY }}
          OPTION_CHAIN_URL: ${{ vars.OPTION_CHAIN_URL }}
          GROWW_ORDER_MODE: ${{ vars.GROWW_ORDER_MODE }}
          GROWW_TOTP_SECRET: ${{ secrets.GROWW_TOTP_SECRET }}
          GROWW_API_KEY: ${{ secrets.GROWW_API_KEY }}
          GROWW_API_SECRET: ${{ secrets.GROWW_API_SECRET }}
          TRADING_START_H: 10
          TRADING_START_M: 0
          TRADING_END_H: 14
          TRADING_END_M: 0
        run: |
          python backend/scripts/execute_trades.py --index SENSEX

  evening-cleanup:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'cleanup') ||
      (github.event_name == 'schedule' && github.event.schedule == '30 14 * * *')
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Clean reports
        run: |
          python backend/generate_reports.py --mode cleanup
      - name: Configure Git user
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      - name: Commit and push cleanup
        run: |
          git add reports/
          if ! git diff --cached --quiet; then
            git commit -m "Delete reports for $(date +'%Y-%m-%d')"
            git push
          else
            echo "No reports to delete or directory already clean"
          fi

  night-generate:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.run_mode == 'night') ||
      (github.event_name == 'schedule' && github.event.schedule == '30 15 * * *')
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install TA-Lib
        run: |
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
          cd ..
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt
      - name: Generate r1 reports
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -n "${{ inputs.run_tag }}" ]; then
            python backend/generate_reports.py --mode generate --run-tag "${{ inputs.run_tag }}"
          else
            python backend/generate_reports.py --mode generate --run-tag r1
          fi
      - name: Configure Git user
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      - name: Commit and push reports
        run: |
          git add reports/
          if ! git diff --cached --quiet; then
            git commit -m "Add night r1 reports for $(date +'%Y-%m-%d')"
            git push
          else
            echo "No changes in reports directory"
          fi
      - name: Clean up temporary files
        run: |
          rm -f backend/charts/* 2>/dev/null || true
